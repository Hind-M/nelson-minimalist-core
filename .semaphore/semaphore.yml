version: v1.0
name: Apple/Mojave Based Pipeline
agent:
  machine:
    type: a1-standard-4
    os_image: macos-mojave

blocks:
  - name: Nelson's build
    task:
      jobs:
      - name: build & tests
        commands:
          - brew update;
          - brew install zlib;
          - brew install libtool;
          - brew install automake;
          - brew install libffi;
          - brew link --force libffi;
          - brew install icu4c;
          - brew link icu4c --force;
          - brew install openmpi;
          - brew install pkg-config;
          - brew install pkgconfig;
          - brew install gettext;
          - brew link --force gettext;
          - brew install boost --with-icu4c;
          - brew install libxml2;
          - brew install cmake;
          - brew install qt5;
          - brew install fftw;
          - brew install portaudio;
          - brew install libsndfile;
          - brew install taglib;
          - cd ~
          - git clone https://github.com/Nelson-numerical-software/nelson-thirdparty-macosx.git;
          - cd nelson-thirdparty-macosx;
          - cd gfortran;
          - sudo hdiutil attach gfortran-6.3-Sierra.dmg;
          - sudo installer -package /Volumes/gfortran-6.3-Sierra/gfortran.pkg -target /;
          - sudo hdiutil detach /Volumes/gfortran-6.3-Sierra;
          - cd ~
          - git clone https://github.com/eigenteam/eigen-git-mirror /tmp/eigen && mkdir /tmp/eigen-build && cd /tmp/eigen && git checkout 3.3.7 && cd - && cd /tmp/eigen-build && FC="nofortran" cmake . /tmp/eigen && make -j4 && sudo make install && cd -;
          - cd ~
          - git clone https://github.com/live-clones/hdf5.git /tmp/hdf5_1_10_5 && cd /tmp/hdf5_1_10_5 && git checkout hdf5-1_10_5 && ./configure --quiet --enable-shared --disable-deprecated-symbols --disable-hl --disable-strict-format-checks --disable-memory-alloc-sanity-check --disable-instrument --disable-parallel --disable-trace --disable-asserts --with-pic --with-default-api-version=v110 CFLAGS="-w" && make install -C src;
          - cd ~
          - git clone https://github.com/tbeu/matio /tmp/matio && cd /tmp/matio && git checkout v1.5.16 && cd /tmp/matio && ./autogen.sh && ./configure --enable-shared --enable-mat73=yes --enable-extended-sparse=no --with-pic --with-hdf5=/tmp/hdf5_1_10_5/hdf5 && make && sudo make install;
          - cd ~
          - brew install hdf5; 
          - git clone https://github.com/Nelson-numerical-software/nelson.git
          - cd nelson
          - export PATH=/usr/local/opt/qt5/bin:$PATH;
          - cmake -G "Unix Makefiles" .
          - make -j4
          - cd ~
          - git clone https://github.com/Nelson-numerical-software/slicot_f2c.git
          - cd slicot_f2c
          - ../nelson/bin/macosx64/nelson-cli --quiet -f build_slicot.nls
          - cd ..
          - cd nelson
          - make buildhelp
          - make missing_help
          - make tests_minimal
          - make package
          - make tests_all
